# vk-test-assignment

Этот репозиторий содержит реализацию тестового задания для стажировки ВК на позицию "Golang Developer"
![image](https://github.com/user-attachments/assets/c9e14430-173b-470d-bb24-61cb209f7c85)

# PubSub Service

Проект реализует систему публикации-подписки (PubSub) с gRPC-интерфейсом. Состоит из двух частей:

## Задание 1

**Основные возможности:**

- Подписка на сообщения по темам (subject)
- Публикация сообщений
- Гарантированный порядок доставки (FIFO)
- Независимая обработка для каждого подписчика
- Потокобезопасность

**Ключевые компоненты:**

- `SubPub` - интерфейс ядра системы
- `Subscribe()` - регистрация подписчика
- `Publish()` - отправка сообщения

## 2. gRPC-сервис (`internal/pubsubservice`)

**gRPC API:**

```protobuf
service PubSub {
  rpc Subscribe(SubscribeRequest) returns (stream Event);
  rpc Publish(PublishRequest) returns (google.protobuf.Empty);
}
```

**Особенности:**

- Streaming-подписки.
- Валидация входящих запросов.
- Логирование операций.
- Конфиг.

Для логирования была использована библиотека [`zap`](https://pkg.go.dev/go.uber.org/zap)

Для конфига была использована библиотека [`cleanenv`](https://github.com/ilyakaznacheev/cleanenv)

## Конфигурация

Пример `config.yaml`:

```yaml
env: "dev"
grpc_server:
  port: 50051
  timeout: 10s

```

Конфигурацию можно указать через переменную окружения `CONFIG_PATH` или флаг `--config`.

## Сборка и запуск

Для сборки используется утилита Make. Если у вас Windows: [Markdown](https://gnuwin32.sourceforge.net/packages/make.htm)

Также потребуется установить утилиту `protoc` и плагин для *Go*. Подробности по установке [тут](https://grpc.io/docs/languages/go/quickstart/)

**Перед тем как выполнять какие-либо `make` команды, выполните `go mod tidy`**

**Команды Make**

- Собрать сервер и клиент: `make`
- Сгенерировать gRPC-код: `make gen`
- Собрать сервер отдельно: `make build-server`
- Собрать клиента отдельно: `make build-client`
- Запустить тесты для задания 1: `make test`
- Запустить подробные тесты для задания 1: `make detailed_test`
- Удалить `bin` директорию: `make clean`

То есть для сборки стоит выполнить следующую последовательность действий:

1. `go mod tidy`
2. `mkdir internal/proto/gen`
3. `make gen`
4. `make`

### Запуск сервера

Запустите сервер с помощью команды:

```
  ./bin/server
```

Если необходимо указать путь к конфигурационному файлу, добавьте флаг `--config`:

```
  ./bin/server --config config/config.yaml
```

Аналогичные команды для запуска клиента (*тестового клиента запускать с тем же самым конфиг-файлом!*)

Также для тестирования можно использовать утилиту [`grpcurl`](https://github.com/fullstorydev/grpcurl)

## Использованные паттерны

При разработке сервиса использовались следующие известные паттерны микросервисов на Go:

1. **Dependency Injection**: Конфигурация, логгер и шина событий (`subpub.SubPub`) передаются в структуру `PubSubServer`
   через конструктор, что упрощает тестирование и замену зависимостей.
2. **Graceful Shutdown**: Сервер корректно завершает работу при получении сигналов SIGINT/SIGTERM, закрывая gRPC-сервер
   и шину событий, что обеспечивает завершение активных соединений без потери данных.
